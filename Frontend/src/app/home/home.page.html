<ion-header style="--background: #fff;" class="ion-no-border" [translucent]="true">
  <ion-toolbar>
    <ion-title>
      Video Downloader
    </ion-title>
    <ion-buttons slot="end">
      <ion-button>
        <ion-icon slot="icon-only" name="logo-facebook"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-segment class="custom-segment" value="custom" [(ngModel)]="segment" (ionChange)="segmentChanged()">
    <ion-segment-button class="custom-button" value="url">
      <ion-label>URL</ion-label>
    </ion-segment-button>
    <ion-segment-button class="custom-button" value="downloads">
      <ion-label>Downloads</ion-label>
    </ion-segment-button>
  </ion-segment>

  <div [ngSwitch]="segment">
    <!-- URL Segment Content -->
    <div *ngSwitchCase="'url'" class="segment-content">
      <ion-item lines="none" class="centered-item">
        <ion-input label="Enter video URL" label-placement="stacked" fill="outline" [clearInput]="true" [(ngModel)]="videoUrl"></ion-input>
        <ion-button (click)="pasteClipboard()">
          Paste
          <ion-icon slot="end" name="clipboard-outline"></ion-icon>
        </ion-button>         
      </ion-item>

      <ion-button class="download-button" expand="block" [disabled]="!videoData?.videoUrl" (click)="downloadVideo()">
        <ion-icon slot="start" name="download-outline"></ion-icon>
        Download
      </ion-button>

      <ion-card *ngFor="let video of downloadingVideos" class="download-card" [@fadeOut]="video.status === 'Completed' ? 'out' : 'in'">
        <ion-item lines="none">
          <ion-thumbnail slot="start">
            <img [src]="video.thumbnail || '../assets/images/defaultThumbnail.png'"/>
          </ion-thumbnail>
          <ion-label>
            <h3>{{ video.name }}</h3>
            <p>{{ video.downloadedSize }} / {{ video.totalSize }} • {{ video.downloadSpeed }}</p>
            <div class="progress-container">
              <ion-progress-bar [value]="video.progress / 100"></ion-progress-bar>
              <p>{{ video.progress }}% {{ video.status }}...</p>
            </div>
          </ion-label>
        </ion-item>
      </ion-card>             

      <!-- Download Card for Completed Video -->
      <ion-card *ngIf="completedVideo" class="completed-video-card" [@fadeOut]="completedVideo.status === 'Completed' ? 'out' : 'in'">
        <ion-item lines="none">
          <!-- Thumbnail with clickable play icon -->
          <ion-thumbnail slot="start" class="completed-thumbnail" (click)="playDownloadedVideo(completedVideo)">
            <img [src]="completedVideo.thumbnail || '../assets/images/defaultThumbnail.png'" />
            <div class="play-overlay">
              <ion-icon name="play-circle" class="play-icon"></ion-icon>
            </div>
          </ion-thumbnail>
          
          <ion-label>
            <h3 style="color: black;">{{ completedVideo.name }}</h3>
            <p>{{ completedVideo.downloadedSize }}</p>
          </ion-label>
          
          <ion-buttons slot="end">
            <!-- Updated Share button with click handler -->
            <ion-button (click)="shareVideo(completedVideo)">
              <ion-icon style="font-size: 25px;" name="share-social-outline" color="primary"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ion-card>
    </div>

    <!-- Downloads Segment Content -->
    <!-- Downloads Segment Content -->
<div *ngSwitchCase="'downloads'" class="segment-content">
  <ion-list lines="none" *ngIf="downloadedVideos.length > 0">
    <ion-list-header>Download History</ion-list-header>
    
    <ion-item *ngFor="let video of downloadedVideos" class="downloaded_videos_card">
      <ion-thumbnail slot="start" class="history-thumbnail">
        <img [src]="video.thumbnail || '../assets/images/defaultThumbnail.png'" />
        <div class="film-icon-overlay">
          <ion-icon name="film-outline" class="film-icon"></ion-icon>
        </div>
      </ion-thumbnail>
      
      <ion-label (click)="playDownloadedVideo(video)">
        <h3 class="videoName">{{ video.name }}</h3>
        <p class="video-meta">{{ video.totalSize }} • {{ video.downloadDate | date: 'd MMM' }} at {{ video.downloadTime }}</p>             
      </ion-label>
      
      <!-- Visible action buttons -->
      <ion-buttons slot="end">
        <ion-button fill="clear" (click)="shareVideo(video)" class="action-button">
          <ion-icon slot="icon-only" name="share-social-outline" color="primary"></ion-icon>
        </ion-button>
        <ion-button fill="clear" (click)="deleteVideo(video.id)" class="action-button">
          <ion-icon slot="icon-only" name="trash-sharp" color="danger"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-item>
  </ion-list>
  
  <div *ngIf="downloadedVideos.length === 0" class="empty-state">
    <ion-icon name="film-outline" color="medium" style="font-size: 48px;"></ion-icon>
    <p style="margin-top: 16px; color: var(--ion-color-medium);">No downloaded videos yet</p>
  </div>
</div>
  </div>
</ion-content>

<!-- Video Player Modal - Placed outside of ion-content -->
<!-- Video Player Modal - Updated to remove play button overlay -->
<!-- Video Player Modal - Updated to remove play button overlay -->
<ion-modal [isOpen]="isVideoModalOpen" (ionModalDidDismiss)="closeVideoPlayer()">
  <ng-template>
    <ion-header class="player-header">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeVideoPlayer()" fill="clear">
            <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title class="player-title">{{currentPlayingVideoName}}</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="player-content" (click)="toggleControls()">
      <div class="video-container" [class.fullscreen]="isFullscreen">
        <!-- Updated video element - removed controls, added key attributes -->
        <video #videoPlayer 
               [muted]="true"
               preload="metadata"
               playsinline
               webkit-playsinline
               class="video-player"
               (click)="$event.stopPropagation()">
          <source [src]="currentPlayingVideo" type="video/mp4">
        </video>
        
        <!-- Spinner Overlay to hide default play button -->
        <div class="video-spinner-overlay" *ngIf="isVideoLoading">
          <div class="spinner-container">
            <ion-spinner name="circular" class="video-spinner"></ion-spinner>
            <p class="spinner-text">Loading video...</p>
          </div>
        </div>
        
        <!-- Custom Controls Overlay -->
        <div class="custom-controls" *ngIf="showCustomControls" (click)="$event.stopPropagation()">
          <div class="progress-container">
            <ion-range 
              [(ngModel)]="videoProgress" 
              (ionChange)="seekVideo()"
              min="0" 
              max="100"
              class="progress-bar">
            </ion-range>
            <div class="time-display">
              <span>{{currentTime | timeFormat}}</span>
              <span>{{duration | timeFormat}}</span>
            </div>
          </div>
          
          <div class="main-controls">
            <ion-button fill="clear" (click)="togglePlay()" class="control-button">
              <ion-icon [name]="isPlaying ? 'pause' : 'play'" class="control-icon"></ion-icon>
            </ion-button>
            <ion-button fill="clear" (click)="toggleMute()" class="control-button">
              <ion-icon [name]="isMuted ? 'volume-mute' : 'volume-medium'" class="control-icon"></ion-icon>
            </ion-button>
            <ion-button fill="clear" (click)="toggleFullscreen()" class="control-button">
              <ion-icon [name]="isFullscreen ? 'contract' : 'expand'" class="control-icon"></ion-icon>
            </ion-button>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>