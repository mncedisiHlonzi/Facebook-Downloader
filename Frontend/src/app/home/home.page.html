<ion-header style="--background: #fff;" class="ion-no-border" [translucent]="true">
  <ion-toolbar>
    <ion-title>
      Video Downloader
    </ion-title>
    <ion-buttons slot="end">
      <ion-button>
        <ion-icon slot="icon-only" name="logo-facebook"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-segment class="custom-segment" value="custom" [(ngModel)]="segment" (ionChange)="segmentChanged()">
    <ion-segment-button class="custom-button" value="url">
      <ion-label>URL</ion-label>
    </ion-segment-button>
    <ion-segment-button class="custom-button" value="downloads">
      <ion-label>Downloads</ion-label>
    </ion-segment-button>
  </ion-segment>

  <div [ngSwitch]="segment">
    <!-- URL Segment Content -->
    <div *ngSwitchCase="'url'" class="segment-content">
      <ion-item lines="none" class="centered-item">
        <ion-input label="Enter video URL" label-placement="stacked" fill="outline" [clearInput]="true" [(ngModel)]="videoUrl"></ion-input>
        <ion-button (click)="pasteClipboard()">
          Paste
          <ion-icon slot="end" name="clipboard-outline"></ion-icon>
        </ion-button>         
      </ion-item>

      <ion-button class="download-button" expand="block" [disabled]="!videoData?.videoUrl" (click)="downloadVideo()">
        <ion-icon slot="start" name="download-outline"></ion-icon>
        Download
      </ion-button>

      <ion-card *ngFor="let video of downloadingVideos" class="download-card" [@fadeOut]="video.status === 'Completed' ? 'out' : 'in'">
        <ion-item lines="none">
          <ion-thumbnail slot="start">
            <img [src]="video.thumbnail || '../assets/images/defaultThumbnail.png'"/>
          </ion-thumbnail>
          <ion-label>
            <h3>{{ video.name }}</h3>
            <p>{{ video.downloadedSize }} / {{ video.totalSize }} • {{ video.downloadSpeed }}</p>
            <div class="progress-container">
              <ion-progress-bar [value]="video.progress / 100"></ion-progress-bar>
              <p>{{ video.progress }}% {{ video.status }}...</p>
            </div>
          </ion-label>
        </ion-item>
      </ion-card>             

      <!--<div *ngIf="videoData" class="video-preview">
        <ion-card class="videoCard">
          <ion-card-header>
            <img [src]="videoData.thumbnail" style="width: 100%; border-radius: 8px;"/>
            <ion-card-title style="margin-top: 8px;">Video Preview</ion-card-title>
          </ion-card-header>  
        </ion-card>
      </div>-->            
    </div>

    <!-- Downloads Segment Content -->
    <div *ngSwitchCase="'downloads'" class="segment-content">
      <ion-list  lines="none" *ngIf="downloadedVideos.length > 0">
        <ion-list-header>Download History</ion-list-header>
        <ion-item-sliding *ngFor="let video of downloadedVideos">
          <ion-item-options side="end">
            <ion-item-option style="color: indigo; margin-right: 5px;">
              <ion-icon slot="icon-only" name="share-social-outline"></ion-icon> Share
            </ion-item-option>
            <ion-item-option style="color: red; margin-right: 5px;" (click)="deleteVideo(video.id)">
              <ion-icon slot="icon-only" name="trash"></ion-icon> Delete
            </ion-item-option>
          </ion-item-options>
      
          <ion-item (click)="playDownloadedVideo(video)" [disabled]="isOpeningVideo" class="downloaded_videos_card">
            <ion-thumbnail slot="start">
              <img [src]="video.thumbnail || '../assets/images/defaultThumbnail.png'" />
            </ion-thumbnail>
            <ion-label>
              <h3 class="videoName">{{ video.name }}</h3>
              <p class="video-meta">{{ video.totalSize }} • {{ video.downloadDate | date: 'd MMM' }} at {{ video.downloadTime }}</p>             
            </ion-label>
            <ion-icon slot="end" style="color: indigo;" name="caret-forward-outline"></ion-icon>
          </ion-item>
        </ion-item-sliding>
      </ion-list>
      <div *ngIf="downloadedVideos.length === 0" class="empty-state">
        <ion-icon name="film-outline" color="medium" style="font-size: 48px;"></ion-icon>
        <p style="margin-top: 16px; color: var(--ion-color-medium);">No downloaded videos yet</p>
      </div>
    </div>
  </div>

  <!-- In your template (home.page.html) -->
<ion-modal [isOpen]="isVideoModalOpen" (ionModalDidDismiss)="closeVideoPlayer()">
  <ng-template>
    <ion-header class="player-header">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeVideoPlayer()" fill="clear">
            <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title class="player-title">{{currentPlayingVideoName}}</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="player-content" (click)="toggleControls()">
      <div class="video-container" [class.fullscreen]="isFullscreen">
        <video #videoPlayer 
               controls 
               controlsList="nodownload noplaybackrate" 
               (click)="$event.stopPropagation()">
          <source [src]="currentPlayingVideo" type="video/mp4">
        </video>
        
        <!-- Custom Controls -->
        <div class="custom-controls" *ngIf="showCustomControls" (click)="$event.stopPropagation()">
          <div class="progress-container">
            <ion-range 
              [(ngModel)]="videoProgress" 
              (ionChange)="seekVideo()"
              min="0" 
              max="100"
              class="progress-bar">
            </ion-range>
            <div class="time-display">
              <span>{{currentTime | timeFormat}}</span>
              <span>{{duration | timeFormat}}</span>
            </div>
          </div>
          
          <div class="main-controls">
            <ion-button fill="clear" (click)="togglePlay()">
              <ion-icon [name]="isPlaying ? 'pause' : 'play'"></ion-icon>
            </ion-button>
            <ion-button fill="clear" (click)="toggleMute()">
              <ion-icon [name]="isMuted ? 'volume-mute' : 'volume-medium'"></ion-icon>
            </ion-button>
            <ion-button fill="clear" (click)="toggleFullscreen()">
              <ion-icon [name]="isFullscreen ? 'contract' : 'expand'"></ion-icon>
            </ion-button>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Download Card for Completed Video -->
<ion-card *ngIf="completedVideo" class="completed-video-card" [@fadeOut]="completedVideo.status === 'Completed' ? 'out' : 'in'">
  <ion-item lines="none">
    <ion-thumbnail slot="start">
      <img [src]="completedVideo.thumbnail || '../assets/images/defaultThumbnail.png'" />
    </ion-thumbnail>
    <ion-label>
      <h3>{{ completedVideo.name }}</h3>
      <p>{{ completedVideo.downloadedSize }}</p>
    </ion-label>
    <ion-buttons slot="end">
      <ion-button (click)="playDownloadedVideo(completedVideo)">
        <ion-icon name="play"></ion-icon>
      </ion-button>
      <ion-button (click)="closeDownloadCard()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-item>
</ion-card>
</ion-content>